name: Release CWL & Containers (Kaniko / Trivy / Skopeo)

on:
  workflow_call:
    inputs:
      tools:
        description: JSON array of tool names
        required: true
        type: string
      registry:
        description: Container registry (e.g. ghcr.io)
        required: true
        type: string
      image-prefix:
        description: Container registry prefix (e.g. org/repo)
        required: true
        type: string
      cwl-workflow-dir:
        description: Directory containing CWL workflow files
        required: true
        type: string
      cwl-tool-dir:
        description: Directory containing tool container files
        required: true
        type: string
    secrets:
      registry-user:
        required: true
      registry-password:
        required: true
      dockerhub-username:
        required: false
      dockerhub-token:
        required: false

jobs:
  # ------------------------------------------------------------
  # Resolve release tag from ref
  # ------------------------------------------------------------
  release-meta:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - id: meta
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" == "refs/heads/develop" ]]; then
            TAG="latest-dev"
          elif [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            TAG="latest"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/v}"
          else
            echo "Unsupported ref ${GITHUB_REF}"
            exit 1
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

  # ------------------------------------------------------------
  # Build, scan, SBOM, push (per tool)
  # ------------------------------------------------------------
  build-scan-push:
    needs: release-meta
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool: ${{ fromJSON(inputs.tools) }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y jq skopeo
          curl -sL https://github.com/oras-project/oras/releases/download/v1.2.2/oras_1.2.2_linux_amd64.tar.gz | tar -xz oras
          sudo mv oras /usr/local/bin/oras

      - name: Configure Docker Hub auth for Kaniko
        run: |
          if [[ -n "${{ secrets.dockerhub-username }}" ]]; then
            mkdir -p $HOME/.docker
            cat > $HOME/.docker/config.json <<EOF
          {
              "auths": {
                "https://index.docker.io/v1/": {
                  "auth": "$(echo -n "${{ secrets.dockerhub-username }}:${{ secrets.dockerhub-token }}" | base64 -w0)"
                }
              }
          }
          EOF
          fi

      - name: Build image with Kaniko (to tar)
        uses: docker://gcr.io/kaniko-project/executor:debug
        env:
          DOCKER_CONFIG: /github/home/.docker
        with:
          args: >
            --context ${{ inputs.cwl-tool-dir }}/${{ matrix.tool }}
            --dockerfile ${{ inputs.cwl-tool-dir }}/${{ matrix.tool }}/Dockerfile
            --no-push
            --tar-path image.tar

      # --------------------------------------------------------
      # Trivy scan (relaxed for now)
      # --------------------------------------------------------
      - name: Trivy scan (debug mode)
        uses: docker://aquasec/trivy:0.50.2
        env:
          TRIVY_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-db
        with:
          args: >
            image
            --input image.tar
            --severity HIGH,CRITICAL
            --exit-code 0
            --no-progress

      - name: Generate SBOM (SPDX JSON)
        uses: docker://aquasec/trivy:0.50.2
        env:
          TRIVY_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-db
        with:
          args: >
            image
            --input image.tar
            --format spdx-json
            --output sbom.spdx.json

      # --------------------------------------------------------
      # Push image and attach SBOM
      # --------------------------------------------------------
      - name: Push image with Skopeo
        id: push
        run: |
          set -euo pipefail

          TAG=${{ needs.release-meta.outputs.tag }}
          REGISTRY="${{ inputs.registry }}"
          IMAGE_PREFIX="${{ inputs.image-prefix }}"
          TOOL="${{ matrix.tool }}"

          IMAGE_REF="${REGISTRY}/${IMAGE_PREFIX}/${TOOL}:${TAG}"

          skopeo copy \
            --dest-creds="${{ secrets.registry-user }}:${{ secrets.registry-password }}" \
            docker-archive:image.tar \
            docker://${IMAGE_REF}

          DIGEST=$(skopeo inspect \
            --creds="${{ secrets.registry-user }}:${{ secrets.registry-password }}" \
            docker://${IMAGE_REF} \
            | jq -r .Digest)

          echo "${REGISTRY}/${IMAGE_PREFIX}/${TOOL}@${DIGEST}" > image.digest

      - name: Attach SBOM to image digest (OCI)
        run: |
          echo "${{ secrets.registry-password }}" \
            | oras login ${{ inputs.registry }} -u "${{ secrets.registry-user }}" --password-stdin

          oras attach \
            --artifact-type application/spdx+json \
            "$(cat image.digest)" \
            sbom.spdx.json:application/spdx+json

      # --------------------------------------------------------
      # Export digest (unique artifact per tool)
      # --------------------------------------------------------
      - name: Export image digest for CWL
        run: |
          mkdir -p digests/${{ matrix.tool }}
          echo "${{ matrix.tool }}=$(cat image.digest)" > digests/${{ matrix.tool }}/images.env

      - uses: actions/upload-artifact@v4
        with:
          name: image-digest-${{ matrix.tool }}
          path: digests/${{ matrix.tool }}/images.env

  # ------------------------------------------------------------
  # Rewrite CWL, validate, publish as OCI artifacts
  # ------------------------------------------------------------
  publish-cwl:
    needs:
      - build-scan-push
      - release-meta
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Download *all* digest artifacts
      - uses: actions/download-artifact@v4
        with:
          path: digests

      - name: Install CWL tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          sudo pip3 install cwltool
          VERSION=v4.45.1
          BINARY=yq_linux_amd64
          wget -q https://github.com/mikefarah/yq/releases/download/${VERSION}/${BINARY}.tar.gz -O - \
          | tar xz
          sudo mv ${BINARY} /usr/bin/yq
          curl -sL https://github.com/oras-project/oras/releases/download/v1.2.2/oras_1.2.2_linux_amd64.tar.gz | tar -xz oras
          sudo mv oras /usr/local/bin/oras

      - name: Merge image digests
        run: |
          set -euo pipefail
          cat digests/**/images.env > digests/all-images.env
          echo "Merged digests:"
          cat digests/all-images.env

      - name: Rewrite CWL dockerPull â†’ digests
        run: |
          set -euo pipefail
          set -x
          while read -r entry
          do
            tool="${entry%%=*}"
            digest="${entry#*=}"

            for cwl in ${{ inputs.cwl-workflow-dir }}/*.cwl
            do
              t="$tool" d="$digest" \
              yq -i '
                (.$graph[] | select(.id == env(t))) as $tool
                | if $tool.requirements.DockerRequirement then
                    $tool.requirements.DockerRequirement.dockerPull = env(d)
                  elif $tool.hints.DockerRequirement then
                    $tool.hints.DockerRequirement.dockerPull = env(d)
                  else
                    error("No DockerRequirement found for tool " + env(t))
                  end
              ' "$cwl"
            done
          done < digests/all-images.env

      - name: Validate CWL
        run: |
          set -euo pipefail
          set -x
          for cwl in ${{ inputs.cwl-workflow-dir }}/*.cwl
          do
            echo "Validating $cwl"
            cat "$cwl"
            cwltool --validate "$cwl"
          done

      - name: Publish CWL as OCI artifacts
        run: |
          set -x
          TAG=${{ needs.release-meta.outputs.tag }}
          OWNER_REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          echo "${{ secrets.registry-password }}" \
            | oras login ${{ inputs.registry }} -u "${{ secrets.registry-user }}" --password-stdin

          cd "${{ inputs.cwl-workflow-dir }}"

          find . -name "*.cwl" -type f | while read -r cwl
          do
            base=$(basename "$cwl")
            name="${base%.cwl}"

            (
              cd "$(dirname "$cwl")"
              oras push \
                ${{ inputs.registry }}/${OWNER_REPO}/${name}:${TAG} \
                --artifact-type application/cwl \
                "${base}:application/cwl"
            )
          done